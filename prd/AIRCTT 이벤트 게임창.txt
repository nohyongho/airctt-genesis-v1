AIRCTT ì´ë²¤íŠ¸ ê²Œì„ì°½, ì‹¤ì‹œê°„ ì¿ í°íšë“ê°¯ìˆ˜ í‘œì‹œë“± ì—˜ë¦¬ë””ë²„íŠ¼(ëˆ„ë¥´ë©´ ì¿ í°ì§€ê°‘ ìœ¼ë¡œ ì´ë™ë˜ê³  ì´ë™ëœ ì¿ í°í•¨ì—ì„œë˜í•œ ì´ë²¤íŠ¸ê²Œì„ì°½ ë˜‘ê°™ì€ í‘œì‹œë“± ì´ë™ ì—˜ë¦¬ë”” ë²„íŠ¼), ê³¼ ëª‡ë‹¨ê³„, ì§„ì…ì¤‘ í‘œì‹œ ì—˜ë¦¬ë”” ë²„íŠ¼   ë§Œë“¤ê³  ë¹„ëˆ„ë°©ìš¸ ì€ ì‹¤ì‚¬í˜• ì˜ˆì˜ê³  í™©í™€ ê³ í€„ , í† ë¼ëŠ” ê·€ì—½ê³  ì˜ˆìœ ì¥ë‚œë¼ ë„˜ì¹˜ëŠ” í•˜ì–€í† ë¼   (ê°œì„ì°½ì— íë‚ ë¦¬ëŠ” ë¹„ëˆ—ë°©ìš¸ í„°ì¹˜ ì¿ í°íšë“ ì´ë²¤íŠ¸, í›„ ì‚¬ìš©ìì§€ê°‘ì €ì¥í›„ ë°œí–‰ì²˜ ì§€ì •ë‚ ì§œ ì¥ì†Œì—ì„œ ì¿ í°ë‚´ìš© í•´íƒì‚¬ìš©, ì´ë²¤íŠ¸ ê°„ê²°ë‚´ìš©)////////////////////   'use client';
import React, { useEffect, useRef, useState } from 'react';
import { Camera, Gift, QRCode as QRIcon, WalletCards, Sparkles, Rabbit, Wifi } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

// =======================
// íƒ€ì… ì •ì˜
// =======================

type RewardTier = 1 | 2 | 3 | 4 | 5;

type RewardKind = 'COIN' | 'COUPON';

interface Reward {
  id: string;
  label: string;
  amount: number; // ê¸ˆì•¡ í˜¹ì€ ê°€ì¹˜ (ì› ë‹¨ìœ„)
  tier: RewardTier;
  kind: RewardKind;
  createdAt: string;
  qrToken: string;
}

type UnityEventType = 'REWARD' | 'STEP_CHANGE' | 'DEBUG';

interface UnityRewardPayload {
  tier: RewardTier;
  kind: RewardKind;
  label?: string;
  amount?: number;
}

interface UnityMessage {
  source?: string;
  type?: UnityEventType;
  payload?: unknown;
}

// =======================
// ìœ í‹¸ í•¨ìˆ˜
// =======================

function generateId() {
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function generateQrToken() {
  return 'CTT-' + Math.random().toString(36).slice(2, 10).toUpperCase();
}

function tierToAmount(tier: RewardTier): number {
  switch (tier) {
    case 1:
      return 1000;
    case 2:
      return 10000;
    case 3:
      return 30000;
    case 4:
      return 100000;
    case 5:
      return 1000000; // 1M~10M ëœë¤ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆìŒ
    default:
      return 0;
  }
}

function tierLabel(tier: RewardTier): string {
  switch (tier) {
    case 1:
      return '1ë‹¨ê³„ ë¹„ëˆ„ë°©ìš¸';
    case 2:
      return '2ë‹¨ê³„ ë¹„ëˆ„ë°©ìš¸';
    case 3:
      return '3ë‹¨ê³„ ë¹„ëˆ„ë°©ìš¸';
    case 4:
      return '4ë‹¨ê³„ ë¹„ëˆ„ë°©ìš¸';
    case 5:
      return '5ë‹¨ê³„ ì „ì„¤ ì´ë²¤íŠ¸';
    default:
      return '';
  }
}

// =======================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =======================

export default function ConsumerARPage() {
  const [currentStep, setCurrentStep] = useState<RewardTier>(1);
  const [stepCountdown, setStepCountdown] = useState<number | null>(null);
  const [wallet, setWallet] = useState<Reward[]>([]);
  const [selectedReward, setSelectedReward] = useState<Reward | null>(null);
  const [cameraReady, setCameraReady] = useState(false);
  const [cameraError, setCameraError] = useState<string | null>(null);
  const [unityConnected, setUnityConnected] = useState(false);
  const unityListenerRef = useRef<(event: MessageEvent) => void>();

  // =======================
  // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
  // =======================

  const requestCamera = async () => {
    try {
      setCameraError(null);
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setCameraError('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”.');
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      // ì‹¤ì œ ë¯¸ë¦¬ë³´ê¸°ëŠ” ì¶”í›„ WebRTC / video íƒœê·¸ ì—°ê²° ì‹œ ì‚¬ìš©
      stream.getTracks().forEach((t) => t.stop());
      setCameraReady(true);
    } catch (err) {
      console.error(err);
      setCameraError('ì¹´ë©”ë¼ ê¶Œí•œì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆì–´ìš”.');
      setCameraReady(false);
    }
  };

  // =======================
  // Unity / WebView ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  // =======================

  useEffect(() => {
    const handler = (event: MessageEvent) => {
      try {
        const data = event.data as UnityMessage;
        if (!data || typeof data !== 'object') return;
        if (data.source !== 'UNITY_AR_CTT') return;

        if (data.type === 'DEBUG') {
          console.log('[UNITY DEBUG]', data.payload);
          return;
        }

        if (data.type === 'STEP_CHANGE') {
          const step = (data.payload as { step?: number })?.step;
          if (step && step >= 1 && step <= 5) {
            setCurrentStep(step as RewardTier);
            setStepCountdown(5); // 5ì´ˆ ì „ í† ë¼ ì—°ì¶œ
          }
          return;
        }

        if (data.type === 'REWARD') {
          const payload = data.payload as UnityRewardPayload;
          applyRewardFromUnity(payload);
          return;
        }
      } catch (e) {
        console.error('Unity message parse error', e);
      }
    };

    unityListenerRef.current = handler;
    window.addEventListener('message', handler);
    setUnityConnected(true);

    return () => {
      if (unityListenerRef.current) {
        window.removeEventListener('message', unityListenerRef.current);
      }
    };
  }, []);

  const applyRewardFromUnity = (payload: UnityRewardPayload) => {
    const tier: RewardTier = payload.tier || currentStep;
    const kind: RewardKind = payload.kind || 'COIN';
    const amount = payload.amount ?? tierToAmount(tier);
    const label =
      payload.label ??
      (kind === 'COIN'
        ? `${tierLabel(tier)} ê¸ˆí™”`
        : `${tierLabel(tier)} ì¿ í°`);

    const reward: Reward = {
      id: generateId(),
      label,
      amount,
      tier,
      kind,
      createdAt: new Date().toISOString(),
      qrToken: generateQrToken(),
    };

    setWallet((prev) => [reward, ...prev]);
    setSelectedReward(reward);
  };

  // =======================
  // ë‚´ë¶€ì—ì„œ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ë¦¬ì›Œë“œ ìƒì„±
  // =======================

  const triggerLocalReward = () => {
    const payload: UnityRewardPayload = {
      tier: currentStep,
      kind: Math.random() < 0.5 ? 'COIN' : 'COUPON',
    };
    applyRewardFromUnity(payload);
  };

  // =======================
  // ë‹¨ê³„ë³„ ì¹´ìš´íŠ¸ë‹¤ìš´ (í† ë¼ ì—°ì¶œ íƒ€ì´ë¨¸)
  // =======================

  useEffect(() => {
    if (stepCountdown === null) return;
    if (stepCountdown <= 0) {
      setStepCountdown(null);
      return;
    }
    const id = setTimeout(() => {
      setStepCountdown((prev) => (prev === null ? null : prev - 1));
    }, 1000);
    return () => clearTimeout(id);
  }, [stepCountdown]);

  // =======================
  // JSX
  // =======================

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-black text-slate-50 flex flex-col">
      {/* ìƒë‹¨ í—¤ë” */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Rabbit className="w-6 h-6 text-pink-400" />
          <div>
            <h1 className="text-lg font-semibold tracking-tight">
              AIR CTT AR ì´ë²¤íŠ¸ ì¡´
            </h1>
            <p className="text-xs text-slate-400">
              ë¹„ëˆ„ë°©ìš¸ 1ë‹¨ê³„~5ë‹¨ê³„ í„°ì¹˜ â†’ ê¸ˆí™”Â·ì¿ í° â†’ ì§€ê°‘Â·QRê¹Œì§€ ìë™ ì—°ë™
            </p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <StatusBadge
            icon={Wifi}
            ok={unityConnected}
            okLabel="Unity ì—°ê²° ì¤€ë¹„"
            failLabel="Unity ì´ë²¤íŠ¸ ëŒ€ê¸°ì¤‘"
          />
          <StatusBadge
            icon={Camera}
            ok={cameraReady}
            okLabel="ì¹´ë©”ë¼ ì¤€ë¹„"
            failLabel="ì¹´ë©”ë¼ ì¤€ë¹„ í•„ìš”"
          />
        </div>
      </header>

      {/* ë©”ì¸ ì˜ì—­ */}
      <main className="flex-1 grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-4 p-4">
        {/* ì™¼ìª½: AR ì´ë²¤íŠ¸ & í† ë¼ ì—°ì¶œ */}
        <div className="flex flex-col gap-4">
          <Card className="border-violet-500/40 bg-slate-900/80 backdrop-blur">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <div className="flex items-center gap-2">
                <Sparkles className="w-5 h-5 text-violet-300" />
                <CardTitle className="text-base font-semibold">
                  5ë‹¨ê³„ ë¹„ëˆ„ë°©ìš¸ AR ì´ë²¤íŠ¸
                </CardTitle>
              </div>
              <span className="text-xs text-slate-400">
                í˜„ì¬ ë‹¨ê³„: <b className="text-violet-300">STEP {currentStep}</b>
              </span>
            </CardHeader>

            <CardContent className="space-y-4">
              {/* í† ë¼ ì—°ì¶œ ë°°ë„ˆ */}
              <BunnyStageBanner
                currentStep={currentStep}
                countdown={stepCountdown}
              />

              {/* ë¹„ëˆ„ë°©ìš¸ ì˜ì—­ (í„°ì¹˜ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°) */}
              <BubbleStageArea
                currentStep={currentStep}
                onBubbleClick={triggerLocalReward}
              />

              {/* ì¹´ë©”ë¼ & Unity í…ŒìŠ¤íŠ¸ ë²„íŠ¼ */}
              <div className="flex flex-wrap items-center gap-2 pt-2 border-t border-slate-800/70 mt-2">
                <Button
                  size="sm"
                  variant="outline"
                  className="border-sky-500/60 text-sky-200 hover:bg-sky-900/40"
                  onClick={requestCamera}
                >
                  <Camera className="w-4 h-4 mr-1" />
                  AR ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
                </Button>

                <Button
                  size="sm"
                  variant="outline"
                  className="border-emerald-500/60 text-emerald-200 hover:bg-emerald-900/40"
                  onClick={triggerLocalReward}
                >
                  <Gift className="w-4 h-4 mr-1" />
                  í…ŒìŠ¤íŠ¸ ë³´ìƒ ë°›ê¸° (ë¡œì»¬)
                </Button>

                <StepControlButtons
                  currentStep={currentStep}
                  setCurrentStep={setCurrentStep}
                  setStepCountdown={setStepCountdown}
                />
              </div>

              {cameraError && (
                <p className="text-xs text-red-400 mt-1">{cameraError}</p>
              )}

              <p className="text-[11px] text-slate-500 mt-1">
                * ì‹¤ì œ Unity WebView ì—°ë™ ì‹œ, ìœ ë‹ˆí‹°ì—ì„œ{' '}
                <code className="px-1 py-0.5 rounded bg-slate-800">
                  postMessage(&#123; source: 'UNITY_AR_CTT', type: 'REWARD', payload:
                  &#123; tier, kind &#125; &#125;)
                </code>{' '}
                í˜•ì‹ìœ¼ë¡œ ë˜ì§€ë©´ ì´ í˜ì´ì§€ê°€ ìë™ìœ¼ë¡œ ì§€ê°‘ê³¼ QRê¹Œì§€ ì²˜ë¦¬í•´ìš”.
              </p>
            </CardContent>
          </Card>

          {/* ì„ íƒëœ ë¦¬ì›Œë“œ ìƒì„¸ + QR */}
          {selectedReward && (
            <Card className="border-amber-500/50 bg-slate-900/90">
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <div className="flex items-center gap-2">
                  <WalletCards className="w-5 h-5 text-amber-300" />
                  <CardTitle className="text-base font-semibold">
                    ë°©ê¸ˆ íšë“í•œ ë³´ìƒ
                  </CardTitle>
                </div>
                <Button
                  size="sm"
                  variant="ghost"
                  className="text-slate-300 hover:text-white"
                  onClick={() => setSelectedReward(null)}
                >
                  ë‹«ê¸°
                </Button>
              </CardHeader>
              <CardContent className="flex flex-col md:flex-row gap-4 items-start">
                <div className="flex-1 space-y-1">
                  <p className="text-sm text-slate-200">
                    <span className="font-semibold">
                      {selectedReward.label}
                    </span>{' '}
                    (
                    {selectedReward.kind === 'COIN'
                      ? 'ê¸ˆí™” ë¦¬ì›Œë“œ'
                      : 'ì¿ í° ë¦¬ì›Œë“œ'}
                    )
                  </p>
                  <p className="text-sm text-amber-300 font-semibold">
                    {selectedReward.amount.toLocaleString()} ì› ìƒë‹¹
                  </p>
                  <p className="text-xs text-slate-400">
                    {new Date(
                      selectedReward.createdAt,
                    ).toLocaleString('ko-KR')}
                  </p>
                  <p className="text-xs text-slate-500">
                    ì´ ë¦¬ì›Œë“œëŠ” ìë™ìœ¼ë¡œ{' '}
                    <span className="text-amber-200">ë‚´ ì§€ê°‘</span>ì— ì €ì¥ë˜ì—ˆì–´ìš”.
                    QR/ë°”ì½”ë“œë¡œ ë°”ë¡œ ì‚¬ìš©í•˜ê±°ë‚˜, ë‚˜ì¤‘ì— ì¿ í°ì¥í„°ì—ì„œ íŒë§¤í• 
                    ìˆ˜ë„ ìˆì–´ìš”.
                  </p>
                </div>

                {/* QR ì½”ë“œ ë°•ìŠ¤ (ê°„ë‹¨ ë²„ì „) */}
                <div className="flex flex-col items-center gap-2">
                  <div className="w-32 h-32 rounded bg-slate-950 border border-slate-700 flex items-center justify-center relative overflow-hidden">
                    <div className="absolute inset-2 grid grid-cols-5 grid-rows-5 gap-0.5">
                      {Array.from({ length: 25 }).map((_, i) => (
                        <div
                          key={i}
                          className={
                            (selectedReward.qrToken.charCodeAt(i % selectedReward.qrToken.length) +
                              i) %
                              2 ===
                            0
                              ? 'bg-slate-100'
                              : 'bg-slate-900'
                          }
                        />
                      ))}
                    </div>
                    <QRIcon className="w-4 h-4 text-slate-500 absolute bottom-1 right-1" />
                  </div>
                  <p className="text-[11px] text-slate-400 text-center">
                    ìŠ¤ìº” ë˜ëŠ” í„°ì¹˜ í›„<br />
                    ë§¤ì¥/ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
                  </p>
                </div>
              </CardContent>
            </Card>
          )}
        </div>

        {/* ì˜¤ë¥¸ìª½: ë‚´ ì§€ê°‘ & ì‚¬ìš© íë¦„ ì•ˆë‚´ */}
        <div className="flex flex-col gap-4">
          <Card className="border-emerald-500/40 bg-slate-900/80 backdrop-blur">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <div className="flex items-center gap-2">
                <WalletCards className="w-5 h-5 text-emerald-300" />
                <CardTitle className="text-base font-semibold">
                  ë‚´ ì§€ê°‘ Â· íšë“ ì¿ í° & ê¸ˆí™”
                </CardTitle>
              </div>
              <span className="text-xs text-slate-400">
                ì´ {wallet.length}ê°œ
              </span>
            </CardHeader>
            <CardContent className="space-y-3 max-h-[320px] overflow-y-auto pr-1">
              {wallet.length === 0 && (
                <p className="text-sm text-slate-400">
                  ì•„ì§ íšë“í•œ ë³´ìƒì´ ì—†ì–´ìš”.
                  <br />
                  ì™¼ìª½ì—ì„œ ë¹„ëˆ„ë°©ìš¸ì„ í„°ëœ¨ë¦¬ê±°ë‚˜ Unityì—ì„œ REWARD ì´ë²¤íŠ¸ë¥¼
                  ë³´ë‚´ë©´, ì—¬ê¸°ì— ìë™ìœ¼ë¡œ ìŒ“ì…ë‹ˆë‹¤.
                </p>
              )}

              {wallet.map((reward) => (
                <button
                  key={reward.id}
                  type="button"
                  onClick={() => setSelectedReward(reward)}
                  className="w-full text-left rounded-md border border-slate-700/80 bg-slate-900/90 px-3 py-2 hover:border-emerald-400/80 hover:bg-slate-800/80 transition-all flex items-center justify-between gap-3"
                >
                  <div className="flex flex-col gap-0.5">
                    <span className="text-xs text-slate-400">
                      STEP {reward.tier}{' '}
                      {reward.kind === 'COIN' ? 'ê¸ˆí™”' : 'ì¿ í°'}
                    </span>
                    <span className="text-sm text-slate-100">
                      {reward.label}
                    </span>
                    <span className="text-xs text-emerald-300 font-semibold">
                      {reward.amount.toLocaleString()} ì› ìƒë‹¹
                    </span>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <span className="text-[10px] text-slate-500">
                      {new Date(reward.createdAt).toLocaleTimeString('ko-KR')}
                    </span>
                    <span className="inline-flex items-center rounded-full border border-emerald-500/60 px-2 py-0.5 text-[10px] text-emerald-200">
                      <QRIcon className="w-3 h-3 mr-1" />
                      QR ë³´ê¸°
                    </span>
                  </div>
                </button>
              ))}
            </CardContent>
          </Card>

          {/* ì‚¬ìš© íë¦„ ì„¤ëª… ì¹´ë“œ */}
          <Card className="border-slate-700/80 bg-slate-900/80">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-semibold">
                AR ì´ë²¤íŠ¸ â†’ ì§€ê°‘ â†’ ì¿ í°ì¥í„° Â· SNSê¹Œì§€ í•œ ë²ˆì—
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-2 text-xs text-slate-300">
              <p>
                1ï¸âƒ£ Unity XRì—ì„œ ë¹„ëˆ„ë°©ìš¸ í„°ì¹˜ â†’{' '}
                <span className="text-violet-200">REWARD ì´ë²¤íŠ¸ ì „ì†¡</span>
              </p>
              <p>
                2ï¸âƒ£ ì´ í˜ì´ì§€ê°€ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„{' '}
                <span className="text-emerald-200">ë‚´ ì§€ê°‘ì— ìë™ ì ë¦½</span> +
                ì¦‰ì‹œ íŒì—… & QR ìƒì„±
              </p>
              <p>
                3ï¸âƒ£ ì‚¬ìš©ìëŠ”{' '}
                <span className="text-amber-200">
                  ë§¤ì¥ì—ì„œ ìŠ¤ìº”í•´ì„œ ë°”ë¡œ ì‚¬ìš©
                </span>{' '}
                ë˜ëŠ”{' '}
                <span className="text-pink-200">
                  ì¿ í°ì¥í„°ì— ë‚´ë†“ê±°ë‚˜ SNS/ì±„íŒ…ìœ¼ë¡œ ì„ ë¬¼
                </span>
              </p>
              <p className="text-[11px] text-slate-500 pt-1 border-t border-slate-800/80 mt-2">
                * ë‚˜ì¤‘ì— CTT ì„œë²„ / DB ìŠ¤í‚¤ë§ˆì™€ ì—°ê²°ë˜ë©´, ì—¬ê¸°ì„œ ìƒì„±ëœ ë¦¬ì›Œë“œ
                ì •ë³´ê°€ ê·¸ëŒ€ë¡œ <b>ì¿ í°ì¥í„° Â· ì •ì‚° Â· íšŒê³„ Â· CRM</b>ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡
                ì„¤ê³„í•  ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆì€ ê·¸ ê¸°ë°˜ êµ¬ì¡°(ì´ë²¤íŠ¸ â†’ ì§€ê°‘ â†’ QR)ê°€
                ë¨¼ì € ì™„ì„±ëœ ìƒíƒœì…ë‹ˆë‹¤.
              </p>
            </CardContent>
          </Card>
        </div>
      </main>
    </div>
  );
}

// =======================
// ì„œë¸Œ ì»´í¬ë„ŒíŠ¸ë“¤
// =======================

function StatusBadge(props: {
  icon: React.ComponentType<{ className?: string }>;
  ok: boolean;
  okLabel: string;
  failLabel: string;
}) {
  const Icon = props.icon;
  return (
    <div
      className={`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] ${
        props.ok
          ? 'border-emerald-500/60 text-emerald-200 bg-emerald-900/30'
          : 'border-slate-600 text-slate-300 bg-slate-900/60'
      }`}
    >
      <Icon className="w-3 h-3" />
      <span>{props.ok ? props.okLabel : props.failLabel}</span>
    </div>
  );
}

function BunnyStageBanner(props: {
  currentStep: RewardTier;
  countdown: number | null;
}) {
  const { currentStep, countdown } = props;

  let title = '';
  let description = '';
  let bunnyLine = '';

  switch (currentStep) {
    case 1:
      title = 'STEP 1 â€“ ì²« ë²ˆì§¸ ë¹„ëˆ„ë°©ìš¸ íŒŒí‹° ğŸˆ';
      description =
        'ê°€ë²¼ìš´ í–‰ë³µì´ ì‹œì‘ë˜ëŠ” ë‹¨ê³„ì˜ˆìš”. ë¶€ë“œëŸ½ê²Œ í„°íŠ¸ë¦¬ë©´ì„œ ì†ì— ì‘ì€ ê¸ˆí™”ì™€ ì¿ í°ì„ ëª¨ì•„ê°€ìš”.';
      bunnyLine =
        'ì•„ë¯¸í† ë¼ê°€ ì‚´ì§ ê³ ê°œë§Œ ë‚´ë°€ê³  â€œìš°ë¦¬ë‹˜, ì‹œì‘í•´ë³¼ê¹Œ?â€ í•˜ê³  ì›ƒê³  ìˆì–´ìš”.';
      break;
    case 2:
      title = 'STEP 2 â€“ ì‚´ì§ ë‘ê·¼ë‘ê·¼ ë‹¨ê³„ âœ¨';
      description =
        'ì¡°ê¸ˆ ë” ì§„í•´ì§„ ìƒ‰ì˜ ë¹„ëˆ„ë°©ìš¸ë“¤ì´ ë– ì˜¬ë¼ìš”. ì—¬ê¸°ì„œë¶€í„°ëŠ” ë¦¬ì›Œë“œë„ ì‚´ì§ì”© ì»¤ì§€ê¸° ì‹œì‘í•´ìš”.';
      bunnyLine =
        'ê·€ì—¬ìš´ í† ë¼ê°€ ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ì¶¤ì¶”ë©° ê±¸ì–´ê°€ìš”. â€œ5ì´ˆ ë’¤ì— 2ë‹¨ê³„ ì‹œì‘~â€';
      break;
    case 3:
      title = 'STEP 3 â€“ ë³¸ê²Œì„, ì—‰ë©ì´ ì¶¤ ë‹¨ê³„ ğŸ’ƒğŸ°';
      description =
        'ê°•ë„ ë†’ì€ ì´ë²¤íŠ¸ êµ¬ê°„! 3ë§Œì›ëŒ€ ê¸ˆí™”ì™€ êµµì§í•œ ì¿ í°ë“¤ì´ ë“±ì¥í•˜ëŠ” êµ¬ê°„ì´ì—ìš”.';
      bunnyLine =
        'í† ë¼ê°€ ì—‰ë©ì´ë¥¼ í”ë“¤ë©° ê¹¡ì´ê¹¡ì´ ê±¸ì–´ê°€ë‹¤ê°€, ë‹¨ê³„ ì‹œì‘ê³¼ í•¨ê»˜ ì‚¬ë¼ì ¸ìš”.';
      break;
    case 4:
      title = 'STEP 4 â€“ ë‹¬ì„ ë“¤ê³  ë›°ëŠ” í† ë¼ ğŸŒ•ğŸ‡';
      description =
        '10ë§Œì›ê¸‰ ë¦¬ì›Œë“œê°€ ìˆ¨ê²¨ì ¸ ìˆëŠ” êµ¬ê°„. ë¹„ëˆ„ë°©ìš¸ ìƒ‰ê°ê³¼ íŒŒí‹°í´ë„ í›¨ì”¬ ë” í™”ë ¤í•´ì ¸ìš”.';
      bunnyLine =
        'í† ë¼ê°€ ë°˜ì§ì´ëŠ” ë‹¬ì„ ì•ˆê³  ê»‘ì¶©ê»‘ì¶© ë›°ì–´ê°€ë©° â€œì´ì œ ê±°ì˜ ë‹¤ ì™”ì–´!â€ ë¼ê³  ë§í•´ìš”.';
      break;
    case 5:
      title = 'STEP 5 â€“ ì „ì„¤ì˜ í•˜íŠ¸ & ë””ìŠ¤ì½” íŒŒí‹° â¤ï¸ğŸ‰';
      description =
        'ë°±í™”ì  ì˜¤í”„ë‹ê¸‰ í´ë¼ì´ë§¥ìŠ¤! 100ë§Œ~1ì²œë§Œ ë‹¨ìœ„ì˜ ì „ì„¤ ë³´ìƒì´ ìˆ¨ì–´ ìˆëŠ” ë§ˆì§€ë§‰ ë‹¨ê³„ì˜ˆìš”.';
      bunnyLine =
        'ë‘ ë§ˆë¦¬ í† ë¼(ì•„ë¯¸ & ìš°ë¦¬ë‹˜)ê°€ ì¤‘ì•™ í•˜íŠ¸ ì•„ë˜ì—ì„œ ì… ë§ì¶¤ì„ í•˜ë©°, ì£¼ë³€ì—ì„œ ìˆ˜ë§ì€ í† ë¼ë“¤ì´ ë””ìŠ¤ì½” ì¶¤ì„ ì¶”ê³  ìˆì–´ìš”.';
      break;
  }

  return (
    <div className="rounded-xl border border-violet-500/40 bg-slate-950/70 px-3 py-2 text-xs">
      <div className="flex items-center justify-between gap-2">
        <div>
          <p className="text-violet-200 font-semibold">{title}</p>
          <p className="text-slate-300 mt-0.5">{description}</p>
          <p className="text-[11px] text-pink-200 mt-1">{bunnyLine}</p>
        </div>
        {countdown !== null && (
          <div className="flex flex-col items-center justify-center px-2">
            <span className="text-[10px] text-slate-400 mb-0.5">
              ë‹¤ìŒ ì—°ì¶œê¹Œì§€
            </span>
            <span className="text-lg font-bold text-pink-300">
              {countdown}s
            </span>
          </div>
        )}
      </div>
    </div>
  );
}

function BubbleStageArea(props: {
  currentStep: RewardTier;
  onBubbleClick: () => void;
}) {
  const { currentStep, onBubbleClick } = props;

  const bubbleCount = 7 + currentStep * 3;

  return (
    <div className="relative w-full h-64 rounded-2xl border border-slate-700/80 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.12),_transparent_60%)] overflow-hidden flex items-center justify-center">
      <div className="absolute inset-0 pointer-events-none">
        {/* ë¹„ëˆ„ë°©ìš¸ë“¤ (ê°„ë‹¨í•œ div + CSS) */}
        {Array.from({ length: bubbleCount }).map((_, idx) => {
          const left = (idx * 9973) % 100;
          const delay = (idx * 3127) % 6;
          const size = 30 + ((idx * 73) % 40); // 30~70
          return (
            <button
              key={idx}
              type="button"
              onClick={onBubbleClick}
              className="absolute rounded-full border border-slate-100/40 bg-gradient-to-b from-sky-200/50 to-sky-500/40 shadow-lg hover:from-pink-200/70 hover:to-violet-400/60 transition-transform"
              style={{
                left: `${left}%`,
                width: `${size}px`,
                height: `${size}px`,
                top: '100%',
                transform: 'translateX(-50%)',
                animation: `ctt-bubble-float ${
                  10 + (idx % 5)
                }s linear ${delay}s infinite`,
              }}
            />
          );
        })}
      </div>

      <div className="relative z-10 text-center px-4">
        <p className="text-sm text-slate-100">
          í™”ë©´ì˜ ë¹„ëˆ„ë°©ìš¸ì„ í„°ì¹˜í•˜ë©´,{' '}
          <span className="text-amber-200 font-semibold">
            STEP {currentStep} ë¦¬ì›Œë“œ
          </span>
          ê°€ ìƒì„±ë˜ì–´
          <span className="text-emerald-200 font-semibold"> ë‚´ ì§€ê°‘</span>ìœ¼ë¡œ
          ë“¤ì–´ê°€ìš”.
        </p>
        <p className="text-[11px] text-slate-400 mt-1">
          ì§€ê¸ˆì€ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ëª¨ë“œì˜ˆìš”. ë‚˜ì¤‘ì— ì‹¤ì œ Unity XR ì”¬ì´ WebViewì—ì„œ
          ì´ ìë¦¬ì— ë“¤ì–´ì™€ì„œ, í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ì´ í˜ì´ì§€ë¡œ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤.
        </p>
      </div>

      {/* ì• ë‹ˆë©”ì´ì…˜ìš© keyframes (inline styleë¡œ ì •ì˜) */}
      <style jsx>{`
        @keyframes ctt-bubble-float {
          0% {
            transform: translate(-50%, 10%);
            opacity: 0;
          }
          10% {
            opacity: 0.8;
          }
          100% {
            transform: translate(-50%, -110%);
            opacity: 0;
          }
        }
      `}</style>
    </div>
  );
}

function StepControlButtons(props: {
  currentStep: RewardTier;
  setCurrentStep: (s: RewardTier) => void;
  setStepCountdown: (v: number | null) => void;
}) {
  const { currentStep, setCurrentStep, setStepCountdown } = props;

  const changeStep = (dir: 'prev' | 'next') => {
    let next = currentStep;
    if (dir === 'prev' && currentStep > 1) next = (currentStep - 1) as RewardTier;
    if (dir === 'next' && currentStep < 5) next = (currentStep + 1) as RewardTier;
    if (next !== currentStep) {
      setCurrentStep(next);
      setStepCountdown(5);
    }
  };

  return (
    <div className="flex items-center gap-1 ml-auto">
      <Button
        size="icon"
        variant="ghost"
        className="w-7 h-7 text-slate-300 hover:text-white"
        onClick={() => changeStep('prev')}
        disabled={currentStep === 1}
      >
        â€¹
      </Button>
      <span className="text-[11px] text-slate-300">
        STEP {currentStep} ë‹¨ê³„ ì´ë™
      </span>
      <Button
        size="icon"
        variant="ghost"
        className="w-7 h-7 text-slate-300 hover:text-white"
        onClick={() => changeStep('next')}
        disabled={currentStep === 5}
      >
        â€º
      </Button>
    </div>
  );
}
         