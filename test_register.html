<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRCTT Phase 2 - ê°€ë§¹ì  ë“±ë¡ í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        .subtitle {
            color: rgba(255,255,255,0.8);
            text-align: center;
            margin-bottom: 30px;
        }

        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab:hover {
            background: rgba(255,255,255,0.3);
        }
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        /* ì¹´ë“œ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        /* ìƒíƒœ í‘œì‹œ */
        .status-box {
            display: none;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status-box.show {
            display: block;
        }
        .status-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-box.info {
            background: #cce5ff;
            border: 1px solid #b8daff;
            color: #004085;
        }

        /* í¼ */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        .form-group label .required {
            color: #e74c3c;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* ê²°ê³¼ ì˜ì—­ */
        .result-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .result-area h4 {
            color: #333;
            margin-bottom: 15px;
        }
        .result-area pre {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
        .checklist {
            list-style: none;
        }
        .checklist li {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .checklist li.done {
            background: #d4edda;
        }
        .checklist li .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .checklist li.done .icon {
            background: #28a745;
            color: white;
        }

        /* ì¶”ì²œ í…œí”Œë¦¿ */
        .template-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .template-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .template-card h5 {
            color: #333;
            margin-bottom: 5px;
        }
        .template-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .template-card .discount {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ìˆ¨ê¹€ */
        .hidden {
            display: none !important;
        }

        /* ë¡œë”© */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì„±ê³µ í™”ë©´ */
        .success-screen {
            text-align: center;
            padding: 40px 20px;
        }
        .success-icon {
            width: 80px;
            height: 80px;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: white;
        }
        .success-screen h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .success-screen p {
            color: #666;
            margin-bottom: 30px;
        }
        .store-url {
            background: #f0f0f0;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            color: #667eea;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ AIRCTT Phase 2 í…ŒìŠ¤íŠ¸</h1>
        <p class="subtitle">ê°€ë§¹ì  ë“±ë¡ â†’ Store ìë™ ìƒì„± â†’ ì¿ í° í…œí”Œë¦¿ ì¶”ì²œ</p>

        <!-- íƒ­ -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('register')">1ï¸âƒ£ ê°€ë§¹ì  ë“±ë¡</button>
            <button class="tab" onclick="showTab('check')">2ï¸âƒ£ Slug ì²´í¬</button>
            <button class="tab" onclick="showTab('verify')">3ï¸âƒ£ DB í™•ì¸</button>
        </div>

        <!-- ë“±ë¡ íƒ­ -->
        <div id="tab-register" class="tab-content">
            <div class="card">
                <h3 class="card-title">ğŸ“ ê°€ë§¹ì  ì…ì  ì‹ ì²­</h3>

                <div id="register-status" class="status-box"></div>

                <!-- ë“±ë¡ í¼ -->
                <div id="register-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ìƒí˜¸ëª… <span class="required">*</span></label>
                            <input type="text" id="businessName" placeholder="ì˜ˆ: ë§›ìˆëŠ” í•œì •ì‹" value="í…ŒìŠ¤íŠ¸ ì‹ë‹¹">
                        </div>
                        <div class="form-group">
                            <label>ëŒ€í‘œìëª… <span class="required">*</span></label>
                            <input type="text" id="ownerName" placeholder="í™ê¸¸ë™" value="í™ê¸¸ë™">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ì—…ì¢… ì¹´í…Œê³ ë¦¬ <span class="required">*</span></label>
                            <select id="category">
                                <option value="restaurant">ë§›ì§‘/ì‹ë‹¹</option>
                                <option value="cafe">ì¹´í˜/ë””ì €íŠ¸</option>
                                <option value="culture">ë¬¸í™”/ê³µì—°</option>
                                <option value="shopping">ì‡¼í•‘/íŒ¨ì…˜</option>
                                <option value="beauty">ë·°í‹°/ìš´ë™</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì „í™”ë²ˆí˜¸ <span class="required">*</span></label>
                            <input type="text" id="phone" placeholder="02-1234-5678" value="02-1234-5678">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ì£¼ì†Œ <span class="required">*</span></label>
                        <input type="text" id="address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..." value="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123">
                    </div>

                    <div class="form-group">
                        <label>ì´ë©”ì¼ (ì„ íƒ)</label>
                        <input type="email" id="email" placeholder="email@example.com">
                    </div>

                    <div class="form-group">
                        <label>ë§¤ì¥ ì†Œê°œ (ì„ íƒ)</label>
                        <textarea id="description" rows="3" placeholder="ê³ ê°ì—ê²Œ ë³´ì—¬ì§ˆ ë§¤ì¥ ì†Œê°œ"></textarea>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="registerMerchant()" id="registerBtn">
                            ğŸ¯ ì…ì  ì‹ ì²­í•˜ê¸°
                        </button>
                    </div>
                </div>

                <!-- ì„±ê³µ í™”ë©´ -->
                <div id="success-screen" class="success-screen hidden">
                    <div class="success-icon">âœ“</div>
                    <h2>ğŸ‰ ì…ì  ì‹ ì²­ ì™„ë£Œ!</h2>
                    <p id="success-message">ê°€ë§¹ì ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

                    <div class="store-url" id="store-url">/store/test-slug</div>

                    <h4 style="text-align:left; margin-bottom:15px;">ğŸ“¦ ì¶”ì²œ ì¿ í° í…œí”Œë¦¿</h4>
                    <div id="recommended-templates"></div>

                    <div class="btn-group" style="justify-content:center; margin-top:30px;">
                        <button class="btn btn-secondary" onclick="resetForm()">ë‹¤ì‹œ ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>

                <!-- ê²°ê³¼ -->
                <div class="result-area" id="register-result" style="display:none;">
                    <h4>ğŸ“‹ API ì‘ë‹µ</h4>
                    <pre id="register-response"></pre>
                </div>
            </div>
        </div>

        <!-- Slug ì²´í¬ íƒ­ -->
        <div id="tab-check" class="tab-content hidden">
            <div class="card">
                <h3 class="card-title">ğŸ” Slug ì¤‘ë³µ ì²´í¬</h3>

                <div id="check-status" class="status-box"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label>í™•ì¸í•  Slug</label>
                        <input type="text" id="checkSlug" placeholder="my-store">
                    </div>
                    <div class="form-group">
                        <label>íƒ€ì…</label>
                        <select id="checkType">
                            <option value="merchant">ê°€ë§¹ì  (merchants)</option>
                            <option value="store">ë§¤ì¥ (stores)</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="checkSlug()">í™•ì¸í•˜ê¸°</button>
                </div>

                <div class="result-area" id="check-result" style="display:none;">
                    <h4>ğŸ“‹ ê²°ê³¼</h4>
                    <pre id="check-response"></pre>
                </div>
            </div>
        </div>

        <!-- DB í™•ì¸ íƒ­ -->
        <div id="tab-verify" class="tab-content hidden">
            <div class="card">
                <h3 class="card-title">âœ… Phase 2 êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>

                <ul class="checklist">
                    <li class="done">
                        <span class="icon">âœ“</span>
                        <span><strong>slug-service.ts</strong> - generateSlug, isValidSlug, mapCategoryToTemplate í•¨ìˆ˜</span>
                    </li>
                    <li class="done">
                        <span class="icon">âœ“</span>
                        <span><strong>/api/slug/check</strong> - Slug ì¤‘ë³µ ì²´í¬ API</span>
                    </li>
                    <li class="done">
                        <span class="icon">âœ“</span>
                        <span><strong>/api/merchant/register</strong> - ê°€ë§¹ì  ë“±ë¡ API</span>
                    </li>
                    <li class="done">
                        <span class="icon">âœ“</span>
                        <span><strong>DB íŠ¸ë¦¬ê±°</strong> - ê°€ë§¹ì  ë“±ë¡ ì‹œ Store/Table ìë™ ìƒì„±</span>
                    </li>
                    <li class="done">
                        <span class="icon">âœ“</span>
                        <span><strong>ì¿ í° í…œí”Œë¦¿</strong> - ì—…ì¢…ë³„ 15ê°œ í…œí”Œë¦¿ (5ê°œ ì¹´í…Œê³ ë¦¬ Ã— 3ê°œ)</span>
                    </li>
                </ul>

                <h3 class="card-title" style="margin-top:30px;">ğŸ“Š Supabaseì—ì„œ í™•ì¸í•  SQL</h3>

                <div class="result-area">
                    <h4>ë“±ë¡ëœ ê°€ë§¹ì  í™•ì¸</h4>
                    <pre>SELECT id, business_name, slug, owner_name, created_at
FROM merchants
ORDER BY created_at DESC
LIMIT 10;</pre>
                </div>

                <div class="result-area">
                    <h4>ìë™ ìƒì„±ëœ Store í™•ì¸</h4>
                    <pre>SELECT s.id, s.name, s.slug, m.business_name as merchant_name
FROM stores s
JOIN merchants m ON m.id = s.merchant_id
ORDER BY s.created_at DESC
LIMIT 10;</pre>
                </div>

                <div class="result-area">
                    <h4>ì¿ í° í…œí”Œë¦¿ í™•ì¸</h4>
                    <pre>SELECT category, title, discount_type, discount_value
FROM coupon_templates
ORDER BY category, sort_order;</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
        const SUPABASE_URL = 'https://ykwttdasdjgcjumxqmwy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrd3R0ZGFzZGpnY2p1bXhxbXd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0ODc5ODIsImV4cCI6MjA1MDA2Mzk4Mn0.b4DX25zxLNXLwMaqhOdCJjM8ZPNGHpXrVJWJ-0_7uJE';

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            document.getElementById('tab-' + tabName).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = 'status-box show ' + type;
            el.innerHTML = message;
        }

        // ê°€ë§¹ì  ë“±ë¡
        async function registerMerchant() {
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ì²˜ë¦¬ì¤‘...';

            const data = {
                business_name: document.getElementById('businessName').value,
                owner_name: document.getElementById('ownerName').value,
                category: document.getElementById('category').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                email: document.getElementById('email').value || null,
                description: document.getElementById('description').value || null,
                approval_status: 'pending'
            };

            // í•„ìˆ˜ í•„ë“œ ì²´í¬
            if (!data.business_name || !data.owner_name || !data.phone || !data.address) {
                showStatus('register-status', 'âŒ í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¯ ì…ì  ì‹ ì²­í•˜ê¸°';
                return;
            }

            try {
                // 1. ê°€ë§¹ì  ë“±ë¡ (Supabase REST API ì§ì ‘ í˜¸ì¶œ)
                const merchantRes = await fetch(`${SUPABASE_URL}/rest/v1/merchants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(data)
                });

                if (!merchantRes.ok) {
                    const errText = await merchantRes.text();
                    throw new Error(errText);
                }

                const merchants = await merchantRes.json();
                const merchant = merchants[0];

                // 2. ìë™ ìƒì„±ëœ Store ì¡°íšŒ
                const storeRes = await fetch(`${SUPABASE_URL}/rest/v1/stores?merchant_id=eq.${merchant.id}&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const stores = await storeRes.json();
                const store = stores[0];

                // 3. ì¿ í° í…œí”Œë¦¿ ì¡°íšŒ
                const templateRes = await fetch(`${SUPABASE_URL}/rest/v1/coupon_templates?category=eq.${data.category}&is_active=eq.true&order=sort_order`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const templates = await templateRes.json();

                // ê²°ê³¼ êµ¬ì„±
                const result = {
                    success: true,
                    merchant: {
                        id: merchant.id,
                        slug: merchant.slug,
                        name: merchant.business_name
                    },
                    store: store ? {
                        id: store.id,
                        name: store.name,
                        slug: store.slug
                    } : null,
                    recommendedTemplates: templates
                };

                // API ì‘ë‹µ í‘œì‹œ
                document.getElementById('register-result').style.display = 'block';
                document.getElementById('register-response').textContent = JSON.stringify(result, null, 2);

                // ì„±ê³µ í™”ë©´ í‘œì‹œ
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('success-screen').classList.remove('hidden');
                document.getElementById('store-url').textContent = `/store/${merchant.slug}`;

                // ì¶”ì²œ í…œí”Œë¦¿ í‘œì‹œ
                const templatesHtml = templates.map(t => `
                    <div class="template-card">
                        <h5>${t.title}</h5>
                        <p>${t.description || ''}</p>
                        <span class="discount">
                            ${t.discount_type === 'percent' ? t.discount_value + '%' : Number(t.discount_value).toLocaleString() + 'ì›'} í• ì¸
                        </span>
                    </div>
                `).join('');
                document.getElementById('recommended-templates').innerHTML = templatesHtml;

                showStatus('register-status', 'âœ… ê°€ë§¹ì ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

            } catch (error) {
                console.error('Error:', error);
                showStatus('register-status', 'âŒ ì˜¤ë¥˜: ' + error.message, 'error');

                document.getElementById('register-result').style.display = 'block';
                document.getElementById('register-response').textContent = error.message;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¯ ì…ì  ì‹ ì²­í•˜ê¸°';
            }
        }

        // í¼ ë¦¬ì…‹
        function resetForm() {
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('success-screen').classList.add('hidden');
            document.getElementById('register-result').style.display = 'none';
            document.getElementById('register-status').className = 'status-box';

            // ìƒˆ í…ŒìŠ¤íŠ¸ ê°’
            document.getElementById('businessName').value = 'í…ŒìŠ¤íŠ¸ ì‹ë‹¹ ' + Date.now();
        }

        // Slug ì²´í¬
        async function checkSlug() {
            const slug = document.getElementById('checkSlug').value;
            const type = document.getElementById('checkType').value;

            if (!slug) {
                showStatus('check-status', 'âŒ Slugë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const table = type === 'store' ? 'stores' : 'merchants';
                const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?slug=eq.${slug}&select=id,slug`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const data = await res.json();
                const isAvailable = !data || data.length === 0;

                const result = {
                    available: isAvailable,
                    slug: slug,
                    existingData: data
                };

                document.getElementById('check-result').style.display = 'block';
                document.getElementById('check-response').textContent = JSON.stringify(result, null, 2);

                if (isAvailable) {
                    showStatus('check-status', `âœ… "${slug}"ëŠ” ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!`, 'success');
                } else {
                    showStatus('check-status', `âŒ "${slug}"ëŠ” ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.`, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus('check-status', 'âŒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('businessName').value = 'í…ŒìŠ¤íŠ¸ ì‹ë‹¹ ' + Math.floor(Date.now() / 1000);
        });
    </script>
</body>
</html>
